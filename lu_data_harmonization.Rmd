---
title: "Land-use data harmonization"
author: "Vincent Pellissier"
date: "8 November 2018"
output:
  pdf_document: default
  html_document: default
classoption: table
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE)
options(kableExtra.latex.load_packages = FALSE)
options(warn = 0)
library(readxl)
library(tidyverse)
library(magrittr)
library(knitr)
library(kableExtra)

path_grassplot <- 'C:/Users/pellissi/Documents/grassplot'
```
This report explains the steps taken to correct the land-use data.
The masterfile used is the version 1.8, as found on Novembre 8th 2018.
The sheet in Grassplot 1.8.xlsx containing the LU information is the sheet 'datasets' and was read and saved as a .rds file to ease the process (faster loading)


```{r, echo = T}
df <- readRDS(file.path(path_grassplot, 'Grassplot 1.8_Data.rds'))
df <- df %>%
        mutate_at(.vars = c(95:104), funs(ifelse(. %in% c('NA', '[NA]'), NA, .)))
```

The columns 98 (mowing frequency) and 100 (grazing intensity) are renamed:
```{r}
names(df)[c(98,100)] <- c('mowing_frequency', 'grazing_intensity')
```

### Correction of the land use column
The file lookup_table_LU.xlsx contains two sheets:

  * land_use_detail: lookup table between the column 96 and other column. This needs to be discussed further before I finalize the table.
  * global_land_use: lookuptable matching the values in column 95 with a new classification. This new classification is a set of binary columns
  (allowing for mixed land-use) plus one declarative column. Each binary column correspond to a management practice (grazed,	mown,	burnt,	fertilized, abandoned,	natural_grassland), the declarative column stores additional information that cannot be put in one of the 6 columns (*i.e* trampled) and
  that will be used afterward. **NOTE** LAS, P, L were noted as land-use for the dataset PL_C and N was noted as land-use for the dataset RU_J. I could not find what these stand for. I assumed that these plots don't have a land-use but the info is still in the column 'other'.

```{r}
lut <- read_excel(file.path(path_grassplot, "lookup_table_LU.xlsx" ),
                 sheet = 'global_land_use')
```

The global_land_use lookup table is used to harmonize the column 95 with the new binary columns:
```{r}
df <- df %>%
    left_join(lut, by = c("Land use (5 standard categories: mown, grazed, abandoned, natural grassland, NA)" = "old_classification"))
```

### Matching new binary columns and intensity columns
In this step, we identify datasets with discrepancies between the new binary columns and the matching intensity column to:

  * Manually check in the original datasets or publications
  * Correct the discrepancies.
    
#### Mowing and mowing intensity
Datasets containing plots for which mowing intensity > 0 & mown != 1) (here and after, we refer to the new binary columns)
```{r}
df %>% 
  filter(`mown` != 1 & `mowing_frequency` != '0' )%>%
    distinct(`Dataset ID`)%>%
    pull()
```

  * EU_K contains **XX** plots classified as natural_grassland which have a mowing frequency. These plots will also be classified as mown
  * EU_K contains **XX** plot classified as abandoned which have a mowing frequency. Only the plot with a frequency >= 0.2 will be classified as mown (abandoned less than 5 years).
```{r}
df[df$`Dataset ID` == 'EU_K',] %<>% 
  mutate(mown = ifelse(!is.na(mowing_frequency), 1, 0))

df[df$`Dataset ID` == 'EU_K',] %<>% 
  mutate(mown = ifelse((is.element(mowing_frequency, c('0.03', '0.05')) | is.na(mowing_frequency)), 0, 1))
```

  * CZ_J contains plot classified as abandoned which have a mowing frequency == 0.05. These will not be classified as mown. (I could not find the original land-use information in CZ_J.xls)



#### Grazing and Grazing intensity
Datasets containing plots for which grazing intensity > 0 & grazed != 1)
```{r}
df %>% 
    filter(`grazed` != 1 & `grazing_intensity` != '0')%>%
    distinct(`Dataset ID`)%>%
    pull()
```

  * IR_A contains 34 plots classified as mown which have a grazing_intensity == 0.1. These plots will be classified as grazed (and also remain mown as indicated in the original database IR_A.xls). **Note for Idoia** In the original DB, the grazing intensity is noted as 1, 2, 3. Is it correct that it stands for low, medium and high intensity, and hence translate as 0.1, 0.5, 1 in the master file?
```{r}
df[df$`Dataset ID` == 'IR_A',] %<>% 
  mutate(grazed = ifelse(grazing_intensity != '0', 1, 0))
```
  * PL_D contains 39 plots classified as mown which have a grazing_intensity == 0.5. These plots will be classified as grazed. (No composition data, so I could not check the original dataset)
  
```{r}
df[df$`Dataset ID` == 'PL_D' & df$grazing_intensity  %in% '0.5',] %<>% 
  mutate(grazed = 1)
```
  
  * TR_B contains 32 plots classified as abandoned which have a grazing_intensity == 0.1. These plots will be classified as grazed (no further info could be found in TR_B.xls)
```{r}
df[df$`Dataset ID` == 'TR_B' & df$grazing_intensity  %in% '0.1',] %<>% 
  mutate(grazed = 1)
```
  
  * UA_G contains reps. 12, 15, 30 and 3 plots classified as natural_grassland which have a grazing_intensity == 'high', 'low', 'middle' or 'overgrazing'. These plots will be classified as grazed (I could not find the original land-use information in UA_G.xls)
  
```{r}
df[df$`Dataset ID` == 'UA_G' & df$grazing_intensity %in% 
     c('high', 'low', 'middle', 'overgrazing'),] %<>% 
  mutate(grazed = 1)
```
  
  * EU_K contains 4 plots classified as natural_grassland which have a grazing_intensity == 0.5. These plots will be classified as grazed (no further info could be found in EU_K.xls)
```{r}
df[df$`Dataset ID` == 'EU_K' & df$grazing_intensity %in% '0.5',] %<>% 
  mutate(grazed = 1)
```

### Matching new and old binary columns
In this step, we identify and correct discrepancies between the newly created and corrected binary column, and the former ones

#### Mowing
There are:

  * 38 plots with mown == 1 & Mowing (1/0) == 0
  * 148 plots with mown == 0 & Mowing (1/0) == 1
  * 6810 plots with mown == 1 & Mowing (1/0) = NA
  * 6 plots with mown = NA & Mowing (1/0) == '?'
```{r, echo = F}
df%>%
  group_by(`mown`, `Mowing (1/0)`)%>%
  summarise(n=n())%>%
  spread(`mown`, n)%>%
  kable()
```
 
   
Datasets containing plots with mown == 1 & Mowing (1/0) == 0 (new vs former column):
```{r}
df %>% 
  filter(`mown` == 1 & `Mowing (1/0)` == '1' )%>%
    distinct(`Dataset ID`)%>%
    pull()
```
  
  
Datasets containing plots with mown == 0 & Mowing (1/0) == 1 (new vs former column):
```{r}
df %>% 
  filter(`mown` == 0 & `Mowing (1/0)` == '0' )%>%
    distinct(`Dataset ID`)%>%
    pull()
```

Datasets containing plots with mown == 1 & Mowing (1/0) = NA (new vs former column)
```{r}
df %>% 
  filter(`mown` == 1 & is.na(`Mowing (1/0)`))%>%
    distinct(`Dataset ID`)%>%
    pull()
```
